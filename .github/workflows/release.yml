name: Homebrew Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to build (e.g., v0.1.3)'
        required: false

jobs:
  build-bottles:
    name: Build Bottles
    uses: ./.github/workflows/build-bottles.yml
    with:
      tag: ${{ github.event.inputs.tag || github.ref_name }}
    secrets: inherit

  update-formula:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: [build-bottles]
    steps:
      - name: Checkout swift-docc-static
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate checksums and update formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.event.inputs.tag || github.ref_name }}
        run: |
          # Strip 'v' prefix for version (v0.1.3 -> 0.1.3)
          VERSION="${TAG#v}"
          echo "VERSION=$VERSION"

          # Download source tarball and calculate SHA256
          wget -q "https://github.com/mipalgu/swift-docc-static/archive/refs/tags/${TAG}.tar.gz" -O source.tar.gz
          SOURCE_SHA256=$(sha256sum source.tar.gz | cut -d' ' -f1)
          echo "SOURCE_SHA256=$SOURCE_SHA256"

          # Download bottles from release
          mkdir -p bottles
          gh release download "${TAG}" --repo mipalgu/swift-docc-static --pattern "swift-docc-static-*.bottle.tar.gz" -D bottles/ || true

          # Calculate bottle checksums
          MACOS_ARM64_SHA256=""
          LINUX_X86_64_SHA256=""

          if [ -f "bottles/swift-docc-static-${VERSION}.arm64_sequoia.bottle.tar.gz" ]; then
            MACOS_ARM64_SHA256=$(sha256sum "bottles/swift-docc-static-${VERSION}.arm64_sequoia.bottle.tar.gz" | cut -d' ' -f1)
            echo "MACOS_ARM64_SHA256=$MACOS_ARM64_SHA256"
          fi

          if [ -f "bottles/swift-docc-static-${VERSION}.x86_64_linux.bottle.tar.gz" ]; then
            LINUX_X86_64_SHA256=$(sha256sum "bottles/swift-docc-static-${VERSION}.x86_64_linux.bottle.tar.gz" | cut -d' ' -f1)
            echo "LINUX_X86_64_SHA256=$LINUX_X86_64_SHA256"
          fi

          # Clone homebrew-tap
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/mipalgu/homebrew-tap.git homebrew-tap
          cd homebrew-tap

          # Generate the formula
          cat > Formula/swift-docc-static.rb << 'FORMULA_EOF'
class SwiftDoccStatic < Formula
  desc "Generate static HTML/CSS documentation for Swift packages"
  homepage "https://github.com/mipalgu/swift-docc-static"
FORMULA_EOF

          echo "  url \"https://github.com/mipalgu/swift-docc-static/archive/refs/tags/${TAG}.tar.gz\"" >> Formula/swift-docc-static.rb
          echo "  sha256 \"${SOURCE_SHA256}\"" >> Formula/swift-docc-static.rb

          cat >> Formula/swift-docc-static.rb << 'FORMULA_EOF'
  license "Apache-2.0"
  env :std
  head "https://github.com/mipalgu/swift-docc-static.git", branch: "main"

FORMULA_EOF

          # Add bottle block if we have bottles
          if [ -n "$MACOS_ARM64_SHA256" ] || [ -n "$LINUX_X86_64_SHA256" ]; then
            echo "  bottle do" >> Formula/swift-docc-static.rb
            echo "    root_url \"https://github.com/mipalgu/swift-docc-static/releases/download/${TAG}\"" >> Formula/swift-docc-static.rb
            if [ -n "$MACOS_ARM64_SHA256" ]; then
              echo "    sha256 cellar: :any_skip_relocation, arm64_sequoia: \"${MACOS_ARM64_SHA256}\"" >> Formula/swift-docc-static.rb
            fi
            if [ -n "$LINUX_X86_64_SHA256" ]; then
              echo "    sha256 cellar: :any_skip_relocation, x86_64_linux: \"${LINUX_X86_64_SHA256}\"" >> Formula/swift-docc-static.rb
            fi
            echo "  end" >> Formula/swift-docc-static.rb
            echo "" >> Formula/swift-docc-static.rb
          fi

          cat >> Formula/swift-docc-static.rb << 'FORMULA_EOF'
  on_macos do
    depends_on :xcode => ["26.0", :build]
  end

  on_linux do
    # Check the original PATH before Homebrew scrubbed it
    original_path = ENV["HOMEBREW_PATH"] || ENV["PATH"]
    swift_found = original_path.split(File::PATH_SEPARATOR).any? do |dir|
      File.exist?(File.join(dir, "swift"))
    end
    depends_on "swift" => :build unless swift_found
  end

  def install
    # If swiftly is in the PATH, ensure its environment variables are set
    # because Homebrew might have scrubbed them even if it kept the PATH.
    original_path = ENV["HOMEBREW_PATH"] || ENV["PATH"]
    swift_dir = original_path.split(File::PATH_SEPARATOR).find do |dir|
      File.exist?(File.join(dir, "swift"))
    end

    if swift_dir && swift_dir.include?("swiftly")
      ENV["SWIFTLY_BIN_DIR"] = swift_dir
      ENV["SWIFTLY_HOME_DIR"] = File.dirname(swift_dir)
    end

    system "swift", "build", "--disable-sandbox", "-c", "release"
    bin.install ".build/release/docc-static"
  end

  test do
    system "#{bin}/docc-static", "--help"
  end
end
FORMULA_EOF

          echo "Generated formula:"
          cat Formula/swift-docc-static.rb

          # Commit and push
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git checkout -b "update-swift-docc-static-${TAG}"
          git add Formula/swift-docc-static.rb
          git commit -m "Update swift-docc-static to ${TAG}" -m "Release includes pre-built bottles for macOS and Linux"
          git push origin "update-swift-docc-static-${TAG}"

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_GITHUB_TOKEN }}
          TAG: ${{ github.event.inputs.tag || github.ref_name }}
        run: |
          gh pr create --title "Update swift-docc-static to ${TAG}" \
            --body "Automated update of swift-docc-static formula for release ${TAG}

Includes pre-built bottles for:
- macOS ARM64 (Sequoia)
- Linux x86_64" \
            --repo mipalgu/homebrew-tap
