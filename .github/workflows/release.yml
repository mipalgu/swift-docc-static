name: Homebrew Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to build (e.g., v0.1.2)'
        required: false

jobs:
  update-formula:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: [build-bottles]
    if: always()
    steps:
      - name: Checkout swift-docc-static
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download bottle checksums
        run: |
          TAG="${{ github.event.inputs.tag || github.ref_name }}"

          # Download release assets to get SHA256 hashes
          gh release download "${TAG}" --repo mipalgu/swift-docc-static --pattern "*.tar.gz" -D bottles/
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update and push formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_GITHUB_TOKEN }}
          TAG: ${{ github.event.inputs.tag || github.ref_name }}
        run: |
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/mipalgu/homebrew-tap.git homebrew-tap
          cd homebrew-tap

          sed -i "s|url \"https://github.com/mipalgu/swift-docc-static/archive/refs/tags/.*\.tar\.gz\"|url \"https://github.com/mipalgu/swift-docc-static/archive/refs/tags/${TAG}.tar.gz\"|" Formula/swift-docc-static.rb

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git checkout -b "update-swift-docc-static-${TAG}"
          git add Formula/swift-docc-static.rb
          git commit -m "Update swift-docc-static to ${TAG}" -m "Release includes pre-built bottles for macOS and Linux"
          git push origin "update-swift-docc-static-${TAG}"

          gh pr create --title "Update swift-docc-static to ${TAG}" \
            --body "Automated update of swift-docc-static formula for release ${TAG}" \
            --repo mipalgu/homebrew-tap
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_GITHUB_TOKEN }}

  build-bottles:
    name: Build Bottles
    uses: ./.github/workflows/build-bottles.yml
    with:
      tag: ${{ github.event.inputs.tag || github.ref_name }}
    secrets: inherit
